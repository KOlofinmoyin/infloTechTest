name: TechTest - Pull Request, Build, Test, and Deploy GitHub Actions

on:
  push:
    branches:
      - '*'

jobs:
  build-test-deploy:
    runs-on: ubuntu-latest

    steps: 
      - name: Display event information
        run: |
          echo "üéâ The job was automatically triggered by a ${{ github.event_name }} event."
          echo "üêß This job is now running on a ${{ runner.os }} server hosted by GitHub!"
          echo "üîé The name of your branch is ${{ github.ref }} and your repository is ${{ github.repository }}."

      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up .NET Core SDK
        uses: actions/setup-dotnet@v1
        with:
          dotnet-version: '8.0.101'

      - name: Navigate to UserManagement.Web directory
        run: cd UserManagement.Web

      - name: List contents of UserManagement.Web directory
        run: ls

      - name: Show content of package.json
        run: cat UserManagement.Web/package.json

      - name: Install npm dependencies
        uses: actions/setup-node@v2
        with:
          node-version: '14'
      - run: npm install

      - name: Build ASP.NET Core application
        run: |
          cd UserManagement.Web
          dotnet build

      - name: Start ASP.NET Core application
        run: |
          cd UserManagement.Web
          dotnet run

      - name: Wait for application to start
        run: sleep 30

      - name: Run Selenium tests
        run: |
          cd UserManagement.Web
          npm test

      - name: Create pull request
        id: create_pr
        if: success() && github.ref != 'refs/heads/main'
        run: |
          gh pr create --title "Automated PR from ${{ github.event.repository.name }}" --body "Automated PR created by GitHub Actions" --base main --head ${{ github.ref }}

      - name: Merge pull request
        if: steps.create_pr.outputs.pr_number
        run: gh pr merge --auto ${{ steps.create_pr.outputs.pr_number }}

      - name: Open HTML report
        run: echo "Your test-report can now be viewed within the directory './mochawesome-report/mochawesome.html'"
